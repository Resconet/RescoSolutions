<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <title>Empty Offline HTML page</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="initial-scale=1, user-scalable=no" />
    <script src="JSBridge.js"></script>
</head>

<body>
    <script>

        function resizeImage(base64Str) {
            var img = new Image();
            img.src = base64Str;
            var canvas = document.createElement('canvas');
            var MAX_WIDTH = 100;
            var MAX_HEIGHT = 100;
            var width = img.width;
            var height = img.height;

            if (width > height) {
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
            } else {
                if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                }
            }
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            return canvas.toDataURL();
        }

        MobileCRM.UI.EntityForm.onSave(
            function (entityForm) {
                var saveHandler = entityForm.suspendSave();
                var general = entityForm.getDetailView("General");
                MobileCRM.bridge.alert(JSON.stringify(general));
                
                var imageItem = general.getItemByName("%image1");
                if (imageItem.value) {
                    MobileCRM.bridge.alert(imageItem.value);
                    imageItem.value = resizeImage(imageItem.value);
                    saveHandler.resumeSave();
                }

            },
            true,
            null
        );

    </script>
</body>

</html>